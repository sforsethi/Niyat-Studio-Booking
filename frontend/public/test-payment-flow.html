<!DOCTYPE html>
<html>
<head>
    <title>Payment Flow Debug Test</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-container { border: 1px solid #ddd; padding: 20px; margin: 10px 0; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        input, button { padding: 8px; margin: 5px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        #log { background: #f8f9fa; padding: 10px; margin: 10px 0; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>Payment Flow Debug Test</h1>
    
    <div class="test-container">
        <h3>Test Payment with Coupon</h3>
        <div>
            <label>Base Amount: </label>
            <input type="number" id="baseAmount" value="2300" />
        </div>
        <div>
            <label>Coupon Code: </label>
            <input type="text" id="couponCode" placeholder="Enter coupon code" value="STUDIO15" />
            <button onclick="applyCoupon()">Apply Coupon</button>
        </div>
        <div id="couponResult"></div>
        <div>
            <label>Final Amount: ‚Çπ</label>
            <span id="finalAmount">2300</span>
        </div>
        <button onclick="testPaymentFlow()">Test Payment Flow</button>
        <div id="paymentResult"></div>
    </div>

    <div class="test-container">
        <h3>Debug Log</h3>
        <button onclick="clearLog()">Clear Log</button>
        <pre id="log"></pre>
    </div>

    <script>
        let discountAmount = 0;
        let finalAmount = 2300;

        function log(message, data = null) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            let logMessage = `[${timestamp}] ${message}`;
            if (data) {
                logMessage += '\n' + JSON.stringify(data, null, 2);
            }
            logElement.innerHTML += logMessage + '\n\n';
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message, data);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function applyCoupon() {
            const code = document.getElementById('couponCode').value;
            const baseAmount = parseInt(document.getElementById('baseAmount').value);
            const resultDiv = document.getElementById('couponResult');
            
            log(`Applying coupon: ${code} on amount: ‚Çπ${baseAmount}`);
            
            try {
                const response = await fetch('/api/validate-coupon', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code.trim(),
                        amount: baseAmount
                    }),
                });

                log(`Coupon validation response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                log('Coupon validation response:', data);

                if (data.valid) {
                    discountAmount = data.discountAmount;
                    finalAmount = data.finalAmount;
                    document.getElementById('finalAmount').textContent = finalAmount;
                    resultDiv.innerHTML = `<div class="result success">‚úÖ Coupon applied! Discount: ‚Çπ${discountAmount}</div>`;
                } else {
                    discountAmount = 0;
                    finalAmount = baseAmount;
                    document.getElementById('finalAmount').textContent = finalAmount;
                    resultDiv.innerHTML = `<div class="result error">‚ùå ${data.error}</div>`;
                }
            } catch (error) {
                log('Coupon validation error:', error.message);
                resultDiv.innerHTML = `<div class="result error">üö® Error: ${error.message}</div>`;
            }
        }

        async function testPaymentFlow() {
            const resultDiv = document.getElementById('paymentResult');
            resultDiv.innerHTML = '<div class="result">Testing payment flow...</div>';
            
            log('Starting payment flow test');
            log('Current amount details:', {
                baseAmount: parseInt(document.getElementById('baseAmount').value),
                discountAmount: discountAmount,
                finalAmount: finalAmount
            });

            try {
                // Step 1: Create Razorpay order
                log('Step 1: Creating Razorpay order with amount:', finalAmount);
                
                const orderResponse = await fetch('/api/create-order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: finalAmount,
                        currency: 'INR'
                    }),
                });

                log(`Create order response status: ${orderResponse.status}`);

                if (!orderResponse.ok) {
                    const errorText = await orderResponse.text();
                    log('Create order error response:', errorText);
                    throw new Error(`Failed to create order: ${orderResponse.status} - ${errorText}`);
                }

                const orderData = await orderResponse.json();
                log('Order created successfully:', orderData);

                // Step 2: Check if Razorpay is loaded
                log('Step 2: Checking Razorpay SDK');
                if (!window.Razorpay) {
                    throw new Error('Razorpay SDK not loaded');
                }
                log('Razorpay SDK is loaded');

                // Step 3: Initialize Razorpay
                const options = {
                    key: 'rzp_live_LoswuqskrUoMJx',
                    amount: orderData.amount,
                    currency: orderData.currency,
                    name: 'Studio Booking Test',
                    description: 'Test payment with coupon',
                    order_id: orderData.id,
                    handler: function (response) {
                        log('Payment successful!', response);
                        resultDiv.innerHTML = `<div class="result success">‚úÖ Payment successful! Payment ID: ${response.razorpay_payment_id}</div>`;
                    },
                    prefill: {
                        name: 'Test User',
                        email: 'test@example.com',
                        contact: '9999999999',
                    },
                    theme: {
                        color: '#3399cc',
                    },
                    modal: {
                        ondismiss: function() {
                            log('Payment cancelled by user');
                            resultDiv.innerHTML = '<div class="result error">Payment cancelled</div>';
                        }
                    }
                };

                log('Step 3: Initializing Razorpay with options:', options);

                const rzp = new window.Razorpay(options);
                rzp.open();

                resultDiv.innerHTML = '<div class="result success">‚úÖ Payment window opened successfully</div>';

            } catch (error) {
                log('Payment flow error:', error.message);
                resultDiv.innerHTML = `<div class="result error">üö® Error: ${error.message}</div>`;
            }
        }

        // Initialize
        log('Payment flow debug test loaded');
        log('Razorpay SDK status:', window.Razorpay ? 'Loaded' : 'Not loaded');
    </script>
</body>
</html>